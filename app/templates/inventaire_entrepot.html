<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Inventaire - {{ entrepot }}</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; }
        canvas { border: 2px solid black; background-color: lightgrey; margin-top: 20px; cursor: pointer; }
        header { background-color: #333; color: white; padding: 15px; font-size: 24px; }
        nav { background-color: #555; padding: 10px; text-align: center; }
        nav ul { list-style: none; padding: 0; }
        nav ul li { display: inline; margin: 0 15px; }
        nav ul li a { color: white; text-decoration: none; font-size: 18px; }
        nav ul li a:hover { text-decoration: underline; }
        #detailsCellule { margin-top: 30px; display: inline-block; text-align: left; width: 80%; }
        table { width: 100%; border-collapse: collapse; background-color: white; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        th { background-color: #333; color: white; }
    </style>
</head>
<body>

<header>üì¶ Inventaire d√©taill√© - {{ entrepot }}</header>

<nav>
    <ul>
        <li><a href="/plan?mode=inventaire">‚¨ÖÔ∏è Retour au Plan</a></li>
        <li><a href="/">üè† Accueil</a></li>
    </ul>
</nav>

<canvas id="entrepotCanvas" width="1600" height="800"></canvas>

<!-- ‚úÖ Ce div est ESSENTIEL -->
<div id="detailsCellule"></div>

<script>
const elements = JSON.parse('{{ elements | tojson | safe }}');
const murs = JSON.parse('{{ murs | tojson | safe }}');
const canvas = document.getElementById("entrepotCanvas");
const ctx = canvas.getContext("2d");

// üé® Dessiner les cellules
elements.forEach(el => {
    const x = el["Position X"];
    const y = 800 - el["Position Y"];
    ctx.fillStyle = el["occupee"] ? "red" : "green";
    ctx.fillRect(x - 20, y - 20, 40, 40);
    ctx.fillStyle = "white";
    ctx.fillText(el["Value"], x - 10, y + 5);
});

// üß† Ajout du gestionnaire de clic
canvas.addEventListener("click", function(event) {
    const rect = canvas.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const clickY = event.clientY - rect.top;

    elements.forEach(el => {
        const elX = el["Position X"];
        const elY = 800 - el["Position Y"];

        if (clickX >= (elX - 20) && clickX <= (elX + 20) && clickY >= (elY - 20) && clickY <= (elY + 20)) {
            const cellule_id = el["id"];
            const cellule_nom = el["Value"];
            console.log("üñ±Ô∏è Cellule cliqu√©e:", cellule_nom, "‚Üí ID:", cellule_id);

            fetch(`/entrepot/api/cellule/${cellule_id}`)
                .then(res => res.json())
                .then(data => {
                    console.log("üì¶ Donn√©es re√ßues pour la cellule:", data);
                    afficherDetailsCellule(cellule_nom, data);
                })
                .catch(err => console.error("‚ùå Erreur lors du fetch :", err));
        }
    });
});

// üìã Fonction d'affichage des d√©tails
function afficherDetailsCellule(cellule, data) {
    const container = document.getElementById("detailsCellule");

    if (!container) {
        console.error("‚ùå Le div #detailsCellule est introuvable !");
        return;
    }

    let html = `<h3>D√©tails pour la cellule <strong>${cellule}</strong></h3>`;

    if (data.length === 0) {
        html += "<p>Aucun produit dans cette cellule.</p>";
    } else {
        html += `<table>
            <thead><tr>
                <th>Produit</th><th>Description</th><th>Quantit√©</th><th>Commande (PO)</th><th>Projet</th>
            </tr></thead><tbody>`;
        data.forEach(item => {
            html += `<tr>
                <td>${item.produit_code}</td>
                <td>${item.description}</td>
                <td>${item.quantite}</td>
                <td>${item.commande_po}</td>
                <td>${item.projet_nom}</td>
            </tr>`;
        });
        html += "</tbody></table>";
    }

    container.innerHTML = html;
}

// üß± Dessin des murs
ctx.strokeStyle = "black";
ctx.lineWidth = 3;
murs.forEach(mur => {
    const x1 = mur["Start X"];
    const y1 = 800 - mur["Start Y"];
    const x2 = mur["End X"];
    const y2 = 800 - mur["End Y"];
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
});
</script>
</body>
</html>
